YUI.add("hermes-templates-photo-charm-contexts",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){return this.compilerInfo=[3,">= 1.0.0-rc.4"],n=n||e.helpers,i=i||{},'<div class="context-views"></div>\n<div class="photostream-context-view"></div>'}),r=e.Template._cache=e.Template._cache||{},i={};e.Array.each([],function(e){r["hermes/"+e]&&(i[e]=r["hermes/"+e])}),r["hermes/photo-charm-contexts"]=function(e){return n(e,{partials:i})}},"@VERSION@",{requires:["handlebars-base"]});
YUI.add("photo-charm-contexts-view",function(e){e.namespace("Views")[this.name]=e.Base.create("photo-charm-contexts-view",e.FlickrView,[],{initializer:function(t){return this.photoId=t.photoId,this.context=e.clone(t.context,!0),this.get("container").html===""&&this.setContainerHTML(""),this},loadState:function(){var t=this;return e.batch(t.appContext.getModel("photo-models",this.photoId),t.appContext.getModel("photo-contexts-models",this.photoId)).then(function(e){t.set("photo",e[0]),t.set("photo-contexts",e[1])})},buildContainer:function(){var e;return e=this.templates("photo-charm-contexts")(),this.setContainerHTML(e),this},activate:function(){var e=this,t=[],n=this.get("photo-contexts"),r;return t=n.registry.getContextsNotOfType(n.id,"photostream-models"),t.length>9&&(t.length=9),e.deferContextLoading(t,function(t){return e.activateContext(t)}),r=n.registry.getContextsOfType(n.id,"photostream-models"),r.length>0&&e.activateContext(r[0],"photostream-view"),n.on("valuesChanged",e.handleContextChanges.bind(e)),this},handleContextChanges:function(e){var t=this.get("container"),n=e.contexts.prevVal,r=e.contexts.newVal.getList(),i,s;n.length>0&&(n.length>r.length?(i=this.diffContextLists(r,n).removed[0].toJSON(),t.one('.context-view[data-context-id="'+i.id+'"]')&&t.one('.context-view[data-context-id="'+i.id+'"]').remove()):(s=this.diffContextLists(r,n).added[1],this.activateContext(s)))},diffContextLists:function(t,n){var r={added:[],removed:[]};return e.Array.each(t,function(t){e.Array.indexOf(n,t)===-1&&r.added.push(t)}),e.Array.each(n,function(n){e.Array.indexOf(t,n)===-1&&r.removed.push(n)}),r},deferContextLoading:function(t,n){var r=this,i=4;t.length<i?e.Array.each(t,function(e){n.call(r,e)}):e.batch.apply(this,t.slice(0,i).map(function(e){return n.call(r,e)})).then(function(){r.isActiveAndInDOM()&&r.deferContextLoading(t.slice(i),n)})},activateContext:function(t,n){var r=this,i=t.registry.name==="photostream-models",s=e.URLHelper.parseContextURL(t.getValue("urlSuffix"),r.get("photo"),this.appContext),o={};return s&&s.params&&(o=s.params),o=e.merge(o,{id:t.id}),this.photosLoadedInContexts=[],r.appContext.getView("context-view",{nsid:r.nsid,photoId:r.photoId,context:{modelName:t.registry.name,params:o},perPage:i?24:8,displayNum:i?16:4,usePageFetcher:this.appContext.flipper.isFlipped("context-slider")||!i,numPrev:0,numNext:16}).then(function(t){return r.subviews[n||e.guid("context-view")]=t,t.on("flickr:photo-charm-contexts-view--track-context-photos",function(e){var n=e.details[0],i,s=[];if(!n)return[];i=n.pop();while(i)r.photosLoadedInContexts.indexOf(i)>-1?s.push(i):r.photosLoadedInContexts.push(i),i=n.pop();t.fire("flickr:photo-charm-contexts-view--duplicate-context-photos",s)}),t.initialize().then(function(){n==="photostream-view"?r.get("container").one(".photostream-context-view")&&r.get("container").one(".photostream-context-view").append(t.get("container")):r.get("container").one(".context-views")&&r.get("container").one(".context-views").append(t.get("container"))})}).then(null,function(e){console.error(String(e),e)})}})},"@VERSION@",{requires:["flickr-view","hermes-templates-photo-charm-contexts","url-helper"],optional:[]});
YUI.add("hermes-templates-photo-charm-exif",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function p(e,t){var n="",r;return n+='\n		<li class="c-charm-item-camera">\n			<i class="ui-icon-camera"></i>\n			'+l((r=(r=e.exif,r==null||r===!1?r:r.camera),typeof r===f?r.apply(e):r))+"\n		</li>\n		",n}function d(e,t){var n="",r;return n+='\n		<li class="c-charm-item-location">\n			<i class="ui-icon-tiny-location"></i>\n			'+l((r=(r=e.location,r==null||r===!1?r:r.text),typeof r===f?r.apply(e):r))+"\n		</li>\n		",n}function v(e,t){var n="",r;return n+='\n			<li class="c-charm-item-lens">\n				<i class="ui-icon-tiny-lens"></i>\n				'+l((r=(r=e.exif,r==null||r===!1?r:r.lensModel),typeof r===f?r.apply(e):r))+"\n			</li>\n		",n}function m(e,t){var n="",r;return n+='\n			<li class="c-charm-item-focal-length">\n				<i class="ui-icon-tiny-focal-length"></i>\n				'+l((r=(r=e.exif,r==null||r===!1?r:r.focalLength),typeof r===f?r.apply(e):r))+"\n			</li>\n		",n}function g(e,t){var n="",r;return n+='\n			<li class="c-charm-item-exposure-time">\n				<i class="ui-icon-tiny-exposure-time"></i>\n				'+l((r=(r=e.exif,r==null||r===!1?r:r.exposureTime),typeof r===f?r.apply(e):r))+"\n			</li>\n		",n}function y(e,t){var n="",r;return n+='\n			<li class="c-charm-item-aperture">\n				<i class="ui-icon-tiny-aperture"></i>\n				'+l((r=(r=e.exif,r==null||r===!1?r:r.fNumber),typeof r===f?r.apply(e):r))+"\n			</li>\n		",n}function b(e,t){var n="",r;return n+='\n			<li class="c-charm-item-iso">\n				<i class="ui-icon-tiny-iso"></i>\n				'+l((r=(r=e.exif,r==null||r===!1?r:r.iso),typeof r===f?r.apply(e):r))+"\n			</li>\n		",n}function w(e,t){var n="",r;return n+='\n			<li class="c-charm-item-flash">\n				<i class="ui-icon-tiny-flash"></i>\n				'+l((r=(r=e.exif,r==null||r===!1?r:r.flash),typeof r===f?r.apply(e):r))+"\n			</li>\n		",n}function E(e,t){var n="",r;return n+='\n			<li class="c-charm-item-metering">\n				<i class="ui-icon-tiny-metering"></i>\n				'+l((r=(r=e.exif,r==null||r===!1?r:r.metering),typeof r===f?r.apply(e):r))+"\n			</li>\n		",n}function S(e,t){var r="",i;r+='\n		<li class="c-charm-item-license">\n			<i class="ui-icon-tiny-copyright"></i>\n			',i=n["if"].call(e,e.isOwner,{hash:{},inverse:h.program(23,N,t),fn:h.program(20,x,t),data:t});if(i||i===0)r+=i;return r+="\n		</li>\n		",r}function x(e,t){var r="",i,s,o;r+='\n			<div class="ui-dropdown ui-dropdown-closed">\n				<span class="ui-dialog-arrow"></span>\n				<ul>\n					',o={hash:{},inverse:h.noop,fn:h.program(21,T,t),data:t},s=(i=n.eachConfigVal,i?i.call(e,"licenseSelect",o):c.call(e,"eachConfigVal","licenseSelect",o));if(s||s===0)r+=s;return r+="\n				</ul>\n			</div>\n			",r}function T(e,t){var r="",i,s;return r+='\n					<li data-action="set" data-value="',(i=n.value)?i=i.call(e,{hash:{},data:t}):(i=e.value,i=typeof i===f?i.apply(e):i),r+=l(i)+'" data-text="',s={hash:{},data:t},r+=l((i=n.truncate,i?i.call(e,e.text,35,!1,s):c.call(e,"truncate",e.text,35,!1,s)))+'">',s={hash:{},data:t},r+=l((i=n.truncate,i?i.call(e,e.text,40,s):c.call(e,"truncate",e.text,40,s)))+"</li>\n					",r}function N(e,t){var r="",i,s;return r+="\n				",s={hash:{},data:t},r+=l((i=n.configVal,i?i.call(e,"licenseDisplay",e.license,s):c.call(e,"configVal","licenseDisplay",e.license,s)))+"\n			",r}function C(e,t){var r="",i;r+='\n		<li class="c-charm-item-safetylevel">\n			<i class="ui-icon-tiny-safety-',(i=n.safetyLevel)?i=i.call(e,{hash:{},data:t}):(i=e.safetyLevel,i=typeof i===f?i.apply(e):i),r+=l(i)+'"></i>\n			',i=n["if"].call(e,e.isOwner,{hash:{},inverse:h.program(34,D,t),fn:h.program(26,k,t),data:t});if(i||i===0)r+=i;return r+="\n		</li>\n		",r}function k(e,t){var r="",i;r+='\n			<div class="ui-dropdown ui-dropdown-closed">\n				<span class="ui-dialog-arrow"></span>\n				<ul>\n				',i=n["if"].call(e,e.isVideo,{hash:{},inverse:h.program(31,M,t),fn:h.program(27,L,t),data:t});if(i||i===0)r+=i;return r+="\n				</ul>\n			</div>\n			",r}function L(e,t){var r="",i,s,o;r+="\n                    ",o={hash:{},inverse:h.noop,fn:h.program(28,A,t),data:t},s=(i=n.eachConfigVal,i?i.call(e,"safetyLevel",o):c.call(e,"eachConfigVal","safetyLevel",o));if(s||s===0)r+=s;return r+="\n                ",r}function A(e,t){var r="",i,s,o;r+="\n                        ",o={hash:{},inverse:h.noop,fn:h.program(29,O,t),data:t},s=(i=n.ifCond,i?i.call(e,e.text,"!==","Restricted",o):c.call(e,"ifCond",e.text,"!==","Restricted",o));if(s||s===0)r+=s;return r+="\n                    ",r}function O(e,t){var r="",i;return r+='\n                            <li data-action="set" data-value="',(i=n.value)?i=i.call(e,{hash:{},data:t}):(i=e.value,i=typeof i===f?i.apply(e):i),r+=l(i)+'" data-text="',(i=n.text)?i=i.call(e,{hash:{},data:t}):(i=e.text,i=typeof i===f?i.apply(e):i),r+=l(i)+'">',(i=n.text)?i=i.call(e,{hash:{},data:t}):(i=e.text,i=typeof i===f?i.apply(e):i),r+=l(i)+"</li>\n                        ",r}function M(e,t){var r="",i,s,o;r+="\n                    ",o={hash:{},inverse:h.noop,fn:h.program(32,_,t),data:t},s=(i=n.eachConfigVal,i?i.call(e,"safetyLevel",o):c.call(e,"eachConfigVal","safetyLevel",o));if(s||s===0)r+=s;return r+="\n                ",r}function _(e,t){var r="",i;return r+='\n                        <li data-action="set" data-value="',(i=n.value)?i=i.call(e,{hash:{},data:t}):(i=e.value,i=typeof i===f?i.apply(e):i),r+=l(i)+'" data-text="',(i=n.text)?i=i.call(e,{hash:{},data:t}):(i=e.text,i=typeof i===f?i.apply(e):i),r+=l(i)+'">',(i=n.text)?i=i.call(e,{hash:{},data:t}):(i=e.text,i=typeof i===f?i.apply(e):i),r+=l(i)+"</li>\n                    ",r}function D(e,t){var r="",i,s;return r+="\n				This photo is <em>",s={hash:{},data:t},r+=l((i=n.configVal,i?i.call(e,"safetyLevel",e.safetyLevel,s):c.call(e,"configVal","safetyLevel",e.safetyLevel,s)))+"</em>\n			",r}this.compilerInfo=[3,">= 1.0.0-rc.4"],n=n||e.helpers,i=i||{};var s="",o,u,a,f="function",l=this.escapeExpression,c=n.helperMissing,h=this;s+='<div class="ui-menu c-charm-list exif-charm-list">\n	<ul>\n		\n		<!-- camera -->\n		\n		'
,u=n["if"].call(t,(o=t.exif,o==null||o===!1?o:o.camera),{hash:{},inverse:h.noop,fn:h.program(1,p,i),data:i});if(u||u===0)s+=u;s+="\n		\n		<!-- location -->\n		\n		",u=n["if"].call(t,(o=t.location,o==null||o===!1?o:o.text),{hash:{},inverse:h.noop,fn:h.program(3,d,i),data:i});if(u||u===0)s+=u;s+="\n\n		<!-- exifs -->\n		\n		",u=n["if"].call(t,(o=t.exif,o==null||o===!1?o:o.lensModel),{hash:{},inverse:h.noop,fn:h.program(5,v,i),data:i});if(u||u===0)s+=u;s+="\n		\n		",u=n["if"].call(t,(o=t.exif,o==null||o===!1?o:o.focalLength),{hash:{},inverse:h.noop,fn:h.program(7,m,i),data:i});if(u||u===0)s+=u;s+="\n		\n		",u=n["if"].call(t,(o=t.exif,o==null||o===!1?o:o.exposureTime),{hash:{},inverse:h.noop,fn:h.program(9,g,i),data:i});if(u||u===0)s+=u;s+="\n		\n		\n		",u=n["if"].call(t,(o=t.exif,o==null||o===!1?o:o.fNumber),{hash:{},inverse:h.noop,fn:h.program(11,y,i),data:i});if(u||u===0)s+=u;s+="\n		\n		",u=n["if"].call(t,(o=t.exif,o==null||o===!1?o:o.iso),{hash:{},inverse:h.noop,fn:h.program(13,b,i),data:i});if(u||u===0)s+=u;s+="\n		\n		",u=n["if"].call(t,(o=t.exif,o==null||o===!1?o:o.flash),{hash:{},inverse:h.noop,fn:h.program(15,w,i),data:i});if(u||u===0)s+=u;s+="\n		\n		",u=n["if"].call(t,(o=t.exif,o==null||o===!1?o:o.metering),{hash:{},inverse:h.noop,fn:h.program(17,E,i),data:i});if(u||u===0)s+=u;s+="\n		\n\n		<!-- permissions -->\n		\n		",a={hash:{},inverse:h.noop,fn:h.program(19,S,i),data:i},u=(o=n.ifCond,o?o.call(t,t.license,"!==","none",a):c.call(t,"ifCond",t.license,"!==","none",a));if(u||u===0)s+=u;s+="\n\n		",a={hash:{},inverse:h.noop,fn:h.program(25,C,i),data:i},u=(o=n.ifCond,o?o.call(t,t.safetyLevel,"!==","none",a):c.call(t,"ifCond",t.safetyLevel,"!==","none",a));if(u||u===0)s+=u;return s+="\n\n	</ul>\n	\n</div>\n",s}),r=e.Template._cache=e.Template._cache||{},i={};e.Array.each([],function(e){r["hermes/"+e]&&(i[e]=r["hermes/"+e])}),r["hermes/photo-charm-exif"]=function(e){return n(e,{partials:i})}},"@VERSION@",{requires:["handlebars-base"]});
YUI.add("photo-charm-exif-view",function(e){var t,n;n={debug:!1,css:{license:".c-charm-item-license .ui-dropdown",safetyLevel:".c-charm-item-safetylevel .ui-dropdown"}},t={log:function(){if(!n.debug||!console.log.apply)return;var e=[].slice.call(arguments);e.unshift("color: #FC0"),e.unshift("%c[CHARM-EXIF]"),console.log.apply(console,e)}},e.namespace("Views")[this.name]=e.Base.create("photo-charm-exif-view",e.FlickrView,[],{initializer:function(e){return this.photoId=e.photoId,this.nsid=e.nsid,this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this},buildContainer:function(){var e,t,n=this.get("photo");return e={exif:this.get("exif")?this.get("exif").toJSON():{},location:this.get("location")?this.get("location").toJSON():{},license:n?n.getValue("license"):"none",safetyLevel:n?n.getValue("safetyLevel"):"none",isOwner:this.get("relationship")?this.get("relationship").getValue("isMe"):!1,isVideo:n?n.getValue("isVideo"):!1},t=this.templates("photo-charm-exif")(e),this.setContainerHTML(t),this},setLicense:function(e){var t=this.get("photo"),n=t.getValue("license"),r=this;t.setValue("license",e),t.remoteUpdate().then(null,function(e){t.setValue("license",n),r.licenseDd.select(n),r.onError("There changing your photo's license"),r.appContext.error(e)}.bind(this))},setSafetyLevel:function(e){var t=this.get("photo"),n=t.getValue("safetyLevel"),r=this,i=this.get("container").one(".c-charm-item-safetylevel i");t.setValue("safetyLevel",e),i.replaceClass("ui-icon-tiny-safety-"+n,"ui-icon-tiny-safety-"+e),t.remoteUpdate().then(null,function(s){t.setValue("safetyLevel",n),r.safetyLevelDd.select(n),i.replaceClass("ui-icon-tiny-safety-"+e,"ui-icon-tiny-safety-"+n),r.onError("There changing your photo's safety level"),r.appContext.error(s)}.bind(this))},handleError:function(e){return function(n){t.log(e,!n.toString||n.toString().match(/^\[object/)?n:n.toString())}},loadState:function(){var t=this,n;return n=new e.FlickrPromise({exif:this.appContext.getModel("photo-exif-models",this.photoId),location:this.appContext.getModel("photo-location-models",this.photoId),photo:t.appContext.getModel("photo-models",t.photoId),relationship:t.appContext.getModel("person-relationship-models",t.nsid)}),n.then(function(e){t.set("exif",e.exif),t.set("location",e.location),t.set("photo",e.photo),t.set("photoPrivacy",e.photoPrivacy),t.set("relationship",e.relationship)})},activate:function(){var t=this;return this.licenseDd=new e.Views.Dropdown({appContext:this.appContext,container:this.get("container").one(n.css.license),selected:this.get("photo").getValue("license"),disabled:!this.get("relationship").getValue("isMe")}),this.licenseDd.on("open",function(n){e.rapidTracker.beacon(t.name,"licenseSettingMenuClick")}),this.licenseDd.on("selected",function(e){t.setLicense(e.value)}),this.safetyLevelDd=new e.Views.Dropdown({appContext:this.appContext,container:this.get("container").one(n.css.safetyLevel),selected:this.get("photo").getValue("safetyLevel"),disabled:!this.get("relationship").getValue("isMe")}),this.safetyLevelDd.on("open",function(n){e.rapidTracker.beacon(t.name,"safetySettingMenuClick")}),this.safetyLevelDd.on("selected",function(e){t.setSafetyLevel(e.value)}),this.on("destroy",function(){t.licenseDd.destroy(),t.safetyLevelDd.destroy()}),this}})},"@VERSION@",{requires:["flickr-view","flickr-promise","dialog","dropdown","hermes-templates-photo-charm-exif"],optional:[]});
YUI.add("hermes-templates-photo-charm-tags",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function c(e,t){return'\n<li contenteditable="true" tabindex="-1" class="tag add-tag">&#43; Add Tag</li>\n'}function h(e,t,r){var i="",s,o,c;i+='\n	<li data-author="',(s=n.tagAuthorNSID)?s=s.call(e,{hash:{},data:t}):(s=e.tagAuthorNSID,s=typeof s===u?s.apply(e):s),i+=a(s)+'" data-tag-id="',(s=n.id)?s=s.call(e,{hash:{},data:t}):(s=e.id,s=typeof s===u?s.apply(e):s),i+=a(s)+'" class="tag ',c={hash:{},inverse:f.noop,fn:f.program(4,p,t),data:t},o=(s=n.canRemoveTag,s?s.call(e,e.tagAuthorNSID,r.viewerNSID,r.isOwner,c):l.call(e,"canRemoveTag",e.tagAuthorNSID,r.viewerNSID,r.isOwner,c));if(o||o===0)i+=o;return i+='"><a class="remove-tag" href="#">x</a><a  href="/photos/tags/',(o=n.tagValue)?o=o.call(e,{hash:{},data:t}):(o=e.tagValue,o=typeof o===u?o.apply(e):o),i+=a(o)+'">',c={hash:{},data:t},i+=a((s=n.truncateLongTags,s?s.call(e,e.tagRaw,40,c):l.call(e,"truncateLongTags",e.tagRaw,40,c)))+"</a></li>\n",i}function p(e,t){return"can-remove-tag"}function d(e,t){var r="",i;r+='\n<h3>Auto Tags</h3>\n\n<ul class="auto-tags-list">\n',i=n.each.call(e,e.autotags,{hash:{},inverse:f.noop,fn:f.program(7,v,t),data:t});if(i||i===0)r+=i;return r+="\n</ul>\n",r}function v(e,t){var r="",i;return r+='\n	<li class="tag"><a href="/photos/tags/',(i=n.tagValue)?i=i.call(e,{hash:{},data:t}):(i=e.tagValue,i=typeof i===u?i.apply(e):i),r+=a(i)+'">',(i=n.tagRaw)?i=i.call(e,{hash:{},data:t}):(i=e.tagRaw,i=typeof i===u?i.apply(e):i),r+=a(i)+"</a></li>\n",r}this.compilerInfo=[3,">= 1.0.0-rc.4"],n=n||e.helpers,i=i||{};var s="",o,u="function",a=this.escapeExpression,f=this,l=n.helperMissing;s+='<h3>Tags</h3>\n\n<ul class="tags-list">\n',o=n["if"].call(t,t.canAddMeta,{hash:{},inverse:f.noop,fn:f.program(1,c,i),data:i});if(o||o===0)s+=o;s+="\n",o=n.each.call(t,t.tags,{hash:{},inverse:f.noop,fn:f.programWithDepth(3,h,i,t),data:i});if(o||o===0)s+=o;s+='\n</ul>\n\n<div style="clear:both;"></div>\n\n',o=n["if"].call(t,t.autotags,{hash:{},inverse:f.noop,fn:f.program(6,d,i),data:i});if(o||o===0)s+=o;return s+="\n\n",s}),r=e.Template._cache=e.Template._cache||{},i={};e.Array.each([],function(e){r["hermes/"+e]&&(i[e]=r["hermes/"+e])}),r["hermes/photo-charm-tags"]=function(e){return n(e,{partials:i})}},"@VERSION@",{requires:["handlebars-base"]});
YUI.add("hermes-templates-photo-charm-tags-tag",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function h(e,t){return'data-tag-might-exist="true"'}this.compilerInfo=[3,">= 1.0.0-rc.4"],n=n||e.helpers,i=i||{};var s="",o,u,a=this,f="function",l=this.escapeExpression,c=n.helperMissing;s+="\n<li ",o=n["if"].call(t,t.mightExist,{hash:{},inverse:a.noop,fn:a.program(1,h,i),data:i});if(o||o===0)s+=o;return s+=' data-tag-id="',(o=n.escapedTagRaw)?o=o.call(t,{hash:{},data:i}):(o=t.escapedTagRaw,o=typeof o===f?o.apply(t):o),s+=l(o)+'" class="tag" data-validated="false"><a class="remove-tag" href="#">x</a><a href="/photos/tags/',(o=n.tagValue)?o=o.call(t,{hash:{},data:i}):(o=t.tagValue,o=typeof o===f?o.apply(t):o),s+=l(o)+'">',u={hash:{},data:i},s+=l((o=n.truncateLongTags,o?o.call(t,t.tagRaw,40,u):c.call(t,"truncateLongTags",t.tagRaw,40,u)))+"</a></li>\n",s}),r=e.Template._cache=e.Template._cache||{},i={};e.Array.each([],function(e){r["hermes/"+e]&&(i[e]=r["hermes/"+e])}),r["hermes/photo-charm-tags-tag"]=function(e){return n(e,{partials:i})}},"@VERSION@",{requires:["handlebars-base"]});
YUI.add("photo-charm-tags-view",function(e){e.namespace("Views")[this.name]=e.Base.create("photo-charm-tags-view",e.FlickrView,[],{initializer:function(t){return this.photoId=t.photoId,this.context=e.clone(t.context,!0),this.get("container").html===""&&this.setContainerHTML(""),this},loadState:function(){var t=this,n=new e.FlickrPromise({photo:t.appContext.getModel("photo-models",t.photoId),photoTags:t.appContext.getModel("photo-tags-models",this.photoId),tagModel:t.appContext.getModelRegistry("tag-models")});return n.then(function(e){t.set("photo",e.photo),t.set("photoTags",e.photoTags),t.set("tagModel",e.tagModel)})},buildContainer:function(){var e,t=this.get("photo"),n=this.get("photoTags"),r=n.getValue("tags");return r&&(r=r.toJSON()),e=this.templates("photo-charm-tags")({tags:r,canAddMeta:t.getValue("isOwner")||t.getValue("canAddMeta"),viewerNSID:this.appContext.getViewer().nsid,isOwner:t.getValue("isOwner")}),this.setContainerHTML(e),this},activate:function(){var t=this.get("photo"),n=this.get("container"),r=t.getValue("owner")||t.getValue("canAddMeta"),i=this;return r&&n.one(".add-tag")&&(this.setupAddTagEvents(),this.setupRollOverTagEvents(),this.setupRemoveTagEvents(),this.registerEventHandler(e.on("flickr:photo-page--new-tags-added",function(){i.buildContainer(),i.setupRollOverTagEvents(),i.setupRemoveTagEvents()}))),this},setupAddTagEvents:function(){var e=this.get("container"),t=this.get("photoTags"),n=t.getValue("tags"),r="+ Add Tag",i=this;this.registerEventHandler(e.one(".add-tag").on("focus",function(){var e=this;setTimeout(function(){e.set("text","")},40)})),this.registerEventHandler(e.one(".add-tag").on("keydown",function(e){e.charCode===13&&(e.preventDefault(),this.blur())})),this.registerEventHandler(e.one(".add-tag").on("blur",function(){var t=this,s=t.get("text");if(s===r)return;s.length===0?s='""':(s.slice(0,1)!=='"'&&(s='"'+s),s.slice(-1,1)!=='"'&&(s+='"')),s.trim()!=='""'&&s.trim()!==r?(n.toJSON().some(function(e){return e.tagValue===s})||(e.one(".tags-list").all(".end-of-the-line").removeClass("end-of-the-line"),i.saveTag(s)),setTimeout(function(){t.focus()},4)):this.set("text",r)}))},saveTag:function(t){var n=this.get("container"),r=this.get("tagModel"),i=this.get("photoTags").getValue("tags"),s=!1,o=this;s=i.getList().some(function(e){return'"'+e.getValue("tagValue")+'"'===t}),r.remoteCreate({photoId:o.photoId,tags:[t]}).then(function(t){var r;t.forEach(function(i){r=n.one(".tags-list").one("[data-tag-id='"+escape(i.getValue("tagRaw"))+"']"),r?(r.setAttribute("data-tag-id",i.getValue("id")),r.setAttribute("data-validated","true"),r.setAttribute("data-tag-might-exist","false"),r.setAttribute("data-author",i.getValue("tagAuthorNSID")),r.addClass("can-remove-tag")):(t.length===e.all("[data-validated='false']").size()&&e.all("[data-validated='false']").remove(!0),n.one(".tags-list").one(".add-tag").insert(o.templates("photo-charm-tags-tag")({tagValue:i.getValue("tagValue"),tagRaw:i.getValue("tagRaw"),escapedTagRaw:escape(i.getValue("tagRaw"))}),"after"),r=n.one(".tags-list").one("[data-tag-id='"+escape(i.getValue("tagRaw"))+"']"),r&&(r.setAttribute("data-tag-id",i.getValue("id")),r.setAttribute("data-validated","true"),r.setAttribute("data-tag-might-exist","false"),r.setAttribute("data-author",i.getValue("tagAuthorNSID")),r.addClass("can-remove-tag")))}),e.all("[data-tag-might-exist='true']").set("text","Duplicate Tag").setAttribute("data-validated","true").addClass("invalid-tag"),e.all("[data-validated='false']").set("text","Invalid Tag").addClass("invalid-tag"),setTimeout(function(){e.all(".invalid-tag").remove(!0)},4500)},function(t){var n=e.Views.dialog.getNewInstance("dialog-alert",{content:"Error adding tag",attrs:{level:"warning"},parent:o});n.show()}),t=t.slice(1,-1),n.one(".tags-list").one(".add-tag").insert(o.templates("photo-charm-tags-tag")({tagValue:t.replace(/\s/g,""),tagRaw:t,escapedTagRaw:escape(t),mightExist:s}),"after")},setupRemoveTagEvents:function(){var t=this.get("container"),n=this.get("photoTags"),r=n.getValue("tags"),i=this.get("tagModel");this.registerEventHandler(t.one(".tags-list").on("click",function(n){if(n.target.hasClass("remove-tag")){n.preventDefault();var s=n.target.ancestor(".tag"),o=s.getAttribute("data-tag-id");r.removeFromList(o,"id"),i.remoteDelete(o).then(null,function(){var t=e.Views.dialog.getNewInstance("dialog-alert",{content:"Error deleting tag",attrs:{level:"warning"},parent:self});t.show()}),s.remove(!0),t.one(".tags-list").all(".end-of-the-line").removeClass("end-of-the-line")}}))},setupRollOverTagEvents:function(){var e=this.get("container");e.all(".tag").on("mouseover",function(e){if(e.target.hasClass("can-remove-tag")){var t=e.target.ancestor(".tags-list").getDOMNode().offsetLeft,n=e.target.getDOMNode().offsetLeft,r=parseInt(e.target.ancestor(".tags-list").getComputedStyle("width").replace("px",""),10),i=e.target.getComputedStyle("height"),s=parseInt(e.target.getComputedStyle("width").replace("px",""),10);r-(n-t+s)<=20&&(e.target.addClass("end-of-the-line"),e.target.one(".remove-tag").setStyle("height",i))}})}})},"@VERSION@",{requires:["flickr-view","dialog","hermes-templates-photo-charm-tags","hermes-templates-photo-charm-tags-tag","photo-charms-tags-css","url-helper"],optional:[]});
